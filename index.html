# Analysis of the Issue

Looking at your code, I can see that the main issue is that the JavaScript code is not properly connected to the HTML elements. The problem appears to be in the structure of your JavaScript code - there's a misplaced closing `</script>` tag that's preventing the rest of your JavaScript from executing properly.

Let me fix this for you:

```html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>USCash üéÆ</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
/* Your CSS remains exactly the same */
:root {
  --primary: #FFD700;
  --secondary: #1E90FF;
  --dark: #0A0A0A;
  --light: #FFFFFF;
  --accent: #FF6347;
}

/* ... all your CSS code ... */

@media (max-width: 480px) {
  h1 {
    font-size: 1.8rem;
  }

  .game-options .gold-box {
    height: 120px;
    font-size: 1rem;
  }

  .game-options .gold-box i {
    font-size: 2rem;
  }

  .tic-tac-toe-board {
    width: 240px;
    height: 240px;
  }

  .card {
    width: 70px;
    height: 90px;
    font-size: 1.8rem;
  }
}
</style>
</head>
<body>
<div id="particles-js"></div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>

<!-- Message icon -->
<div class="message-icon" onclick="showAnnouncements()">
  <i class="fas fa-bullhorn"></i>
</div>

<!-- Announcement Bar -->
<div class="announcement-bar">
  <div class="announcement-content">
    <span>üì¢ Stay connected with us!</span> For deposits, contact VIP users (verified with blue tick) or WhatsApp us at USCash WhatsApp channel
  </div>
</div>

<div id="welcomePopup">
  <div class="popup-content">
    <div class="close" onclick="document.getElementById('welcomePopup').style.display='none'">√ó</div>
    <h2>Welcome to USCash! üéÆ</h2>
    <p>Experience the thrill of gaming with real rewards. We're constantly improving our platform to bring you the best gaming experience.</p>
    <p>New games and features are coming soon - stay tuned!</p>
    <button class="gold-box" onclick="document.getElementById('welcomePopup').style.display='none'" style="margin-top: 20px;">
      Let's Play!
    </button>
  </div>
</div>

<!-- Auth Modals -->
<div id="authModal" class="auth-modal">
  <div class="auth-content">
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
      <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
    </div>

    <div id="loginForm" class="auth-form active">
      <input type="email" id="loginEmail" placeholder="Email" required />
      <input type="password" id="loginPassword" placeholder="Password" required />
      <div class="forgot-password" onclick="showForgotPassword()">Forgot Password?</div>
      <button onclick="loginUser()">Login</button>
    </div>

    <div id="signupForm" class="auth-form">
      <input type="text" id="signupName" placeholder="Full Name" required />
      <input type="tel" id="signupPhone" placeholder="Phone Number" required />
      <input type="email" id="signupEmail" placeholder="Email" required />
      <input type="password" id="signupPassword" placeholder="Password (6+ characters)" required minlength="6" />
      <input type="text" id="referralCode" placeholder="Referral Code (Optional)" />
      <button onclick="signupUser()">Sign Up</button>
    </div>

    <div id="forgotPasswordForm" class="auth-form">
      <input type="email" id="forgotEmail" placeholder="Enter your email" required />
      <button onclick="resetPassword()">Reset Password</button>
      <button onclick="backToLogin()" style="margin-top: 10px; background-color: #444;">Back to Login</button>
    </div>
  </div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="admin-panel">
  <div class="admin-content">
    <div class="admin-close" onclick="hideAdminPanel()">√ó</div>
    <h2>Admin Panel</h2>
    
    <div class="admin-section">
      <h3>User Management</h3>
      <input type="text" id="adminUserSearch" class="admin-search" placeholder="Search users by name..." onkeyup="searchUsers()">
      <div class="admin-table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminUsersList">
            <!-- Users will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="admin-section">
      <h3>Deposit Requests</h3>
      <table class="admin-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adminDepositRequests">
          <!-- Deposit requests will be populated here -->
        </tbody>
      </table>
    </div>
    
    <div class="admin-section">
      <h3>Withdrawal Requests</h3>
      <table class="admin-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adminWithdrawalRequests">
          <!-- Withdrawal requests will be populated here -->
        </tbody>
      </table>
    </div>
    
    <div class="admin-section">
      <h3>Send Announcement</h3>
      <div class="form-group">
        <textarea id="announcementText" placeholder="Type your announcement here..." style="width: 100%; height: 100px; padding: 10px; border-radius: 8px; background-color: #222; color: white; border: 1px solid #444;"></textarea>
      </div>
      <button class="submit-btn" onclick="sendAnnouncement()">Send Announcement</button>
    </div>
  </div>
</div>

<h1>USCash üéÆ</h1>

<div class="user-info">
  <div id="userDisplay" style="display:none;">
    <img src="https://flagcdn.com/w20/pk.png" class="country-flag" alt="Country Flag" id="countryFlag">
    <span id="usernameDisplay"></span>
    <span id="phoneDisplay"></span>
    <i class="fas fa-check-circle verified-badge" id="verifiedBadge" style="display:none;"></i>
  </div>
  <div class="balance-container">
    <span>Balance: Rs. <span id="balanceAmount">0</span></span>
    <i class="fas fa-sync-alt refresh-balance" onclick="refreshBalance()"></i>
  </div>
  <div id="authButtons">
    <button class="gold-box" onclick="showAuthModal('login')">Login</button>
    <button class="gold-box" onclick="showAuthModal('signup')">Sign Up</button>
  </div>
  <div id="logoutButton" style="display:none;">
    <button class="gold-box" onclick="logoutUser()">Logout</button>
  </div>
  <div id="adminButton" style="display:none;">
    <button class="gold-box" onclick="showAdminPanel()">Admin</button>
  </div>
</div>

<div class="nav">
  <a href="#" onclick="showSection('home')"><i class="fas fa-home"></i> Home</a>
  <a href="#" onclick="showSection('deposit')"><i class="fas fa-money-bill-wave"></i> Deposit</a>
  <a href="#" onclick="showSection('withdraw')"><i class="fas fa-wallet"></i> Withdraw</a>
  <a href="#" onclick="showSection('vip')"><i class="fas fa-crown"></i> VIP</a>
  <a href="#" onclick="showSection('more')"><i class="fas fa-ellipsis-h"></i> More</a>
</div>

<!-- Home Section -->
<div class="section" id="homeSection">
  <h2>Select Game</h2>
  <div class="game-options">
    <div class="gold-box scratch-thumbnail" onclick="startCardGame()">
      <i class="fas fa-scroll"></i>
      Scratch Match
    </div>
    <div class="gold-box fruit-thumbnail" onclick="startFruitGame()">
      <i class="fas fa-apple-alt"></i>
      Fruit Shooting
    </div>
    <div class="gold-box tictactoe-thumbnail" onclick="startTicTacToeGame()">
      <i class="fas fa-times"></i>
      Tic Tac Toe
    </div>
    <div class="gold-box findace-thumbnail" onclick="startFindAceGame()">
      <i class="fas fa-search"></i>
      Find Ace
    </div>
    <div class="gold-box archery-thumbnail" onclick="startArcheryGame()">
      <i class="fas fa-bullseye"></i>
      Archery Challenge
    </div>
  </div>
</div>

<!-- Scratch Game -->
<div class="section" id="scratchGame" style="display:none;">
  <h2><i class="fas fa-scroll"></i> Scratch & Match</h2>
  <div class="bet-amounts">
    <div class="gold-box" onclick="selectBet(20)">20</div>
    <div class="gold-box" onclick="selectBet(50)">50</div>
    <div class="gold-box" onclick="selectBet(100)">100</div>
    <div class="gold-box" onclick="selectBet(150)">150</div>
    <div class="gold-box" onclick="selectBet(200)">200</div>
    <div class="gold-box" onclick="selectBet(300)">300</div>
  </div>
  <div class="card-grid" id="cardGrid"></div>
  <div id="result"></div>
</div>

<!-- Fruit Game -->
<div class="section" id="fruitGame" style="display:none;">
  <h2><i class="fas fa-apple-alt"></i> Fruit Shooting</h2>
  <div id="fruitTargetDisplay">Target: Shoot the <b style="color:red;">RED</b> Apple üçé!</div>
  <div class="bet-amounts">
    <div class="gold-box" onclick="startFruitRound(20)">Rs. 20</div>
    <div class="gold-box" onclick="startFruitRound(50)">Rs. 50</div>
    <div class="gold-box" onclick="startFruitRound(100)">Rs. 100</div>
    <div class="gold-box" onclick="startFruitRound(150)">Rs. 150</div>
    <div class="gold-box" onclick="startFruitRound(200)">Rs. 200</div>
  </div>
  <div id="fruitCountdown">Time: 0s</div>
  <div class="shoot-area" id="shootArea"></div>
  <div id="fruitScoreDisplay"></div>
</div>

<!-- Tic Tac Toe Game -->
<div class="section" id="tictactoeGame" style="display:none;">
  <h2><i class="fas fa-times"></i> Tic Tac Toe</h2>
  <div class="bet-amounts">
    <div class="gold-box" onclick="selectTicTacToeBet(50)">Rs. 50</div>
    <div class="gold-box" onclick="selectTicTacToeBet(100)">Rs. 100</div>
    <div class="gold-box" onclick="selectTicTacToeBet(200)">Rs. 200</div>
    <div class="gold-box" onclick="selectTicTacToeBet(300)">Rs. 300</div>
  </div>
  <div id="tictactoeCountdown">Time: 30s</div>
  <div class="tic-tac-toe-board" id="ticTacToeBoard"></div>
  <div id="tictactoeResult"></div>
</div>

<!-- Find Ace Game -->
<div class="section" id="findAceGame" style="display:none;">
  <h2><i class="fas fa-search"></i> Find Ace</h2>
  <div class="bet-amounts">
    <div class="gold-box" onclick="startFindAceRound(50)">Rs. 50</div>
    <div class="gold-box" onclick="startFindAceRound(100)">Rs. 100</div>
    <div class="gold-box" onclick="startFindAceRound(200)">Rs. 200</div>
    <div class="gold-box" onclick="startFindAceRound(300)">Rs. 300</div>
  </div>
  <div id="findAceCountdown">Time: 15s</div>
  <div class="card-grid" id="findAceGrid"></div>
  <div id="findAceResult"></div>
</div>

<!-- Archery Game -->
<div class="section" id="archeryGame" style="display:none;">
  <h2><i class="fas fa-bullseye"></i> Archery Challenge</h2>
  <div class="archery-container">
    <div class="archery-canvas-container">
      <canvas id="archeryCanvas" width="520" height="520"></canvas>
    </div>

    <div class="archery-controls">
      <div class="bet-amounts">
        <div class="gold-box" onclick="selectArcheryBet(20)">Rs. 20</div>
        <div class="gold-box" onclick="selectArcheryBet(50)">Rs. 50</div>
        <div class="gold-box" onclick="selectArcheryBet(100)">Rs. 100</div>
        <div class="gold-box" onclick="selectArcheryBet(150)">Rs. 150</div>
        <div class="gold-box" onclick="selectArcheryBet(200)">Rs. 200</div>
      </div>

      <div class="archery-score-row" id="archeryScoreRow">
        <div class="archery-score-box"></div>
        <div class="archery-score-box"></div>
        <div class="archery-score-box"></div>
        <div class="archery-score-box"></div>
        <div class="archery-score-box"></div>
      </div>

      <div id="archeryStatus">Pick a bet to start</div>

      <div style="display: flex; justify-content: center; gap: 10px;">
        <button class="gold-box" onclick="resetArcheryGame()">Reset</button>
        <button class="gold-box" onclick="toggleArcheryAuto()" id="archeryAutoBtn">Auto: OFF</button>
      </div>
    </div>
  </div>
</div>

<!-- Deposit Section -->
<div class="section" id="depositSection" style="display:none;">
  <h2><i class="fas fa-money-bill-wave"></i> Deposit</h2>
  <p style="color: var(--secondary);">Minimum deposit amount is Rs. 150. To deposit, please contact VIP users (verified with blue tick) or WhatsApp us at USCash WhatsApp channel</p>
  <div class="form-group">
    <label for="depositAmount">Amount (Rs.)</label>
    <input type="number" id="depositAmount" min="150" placeholder="Minimum 150" />
  </div>
  <div class="form-group">
    <label for="depositMethod">Payment Method</label>
    <select id="depositMethod">
      <option value="easypaisa">EasyPaisa</option>
      <option value="jazzcash">JazzCash</option>
      <option value="bank">Bank Transfer</option>
    </select>
  </div>
  <div class="form-group">
    <label for="transactionId">Transaction ID</label>
    <input type="text" id="transactionId" placeholder="Enter transaction reference" />
  </div>
  <button class="submit-btn" onclick="submitDeposit()">Submit Deposit Request</button>

  <div class="transaction-history" id="depositHistory">
    <h3><i class="fas fa-history"></i> Deposit History</h3>
    <!-- Will be populated by JavaScript -->
  </div>
</div>

<!-- Withdraw Section -->
<div class="section" id="withdrawSection" style="display:none;">
  <h2><i class="fas fa-wallet"></i> Withdraw</h2>
  <p style="color: var(--secondary);">Minimum withdrawal amount is Rs. 300. You can submit requests anytime.</p>
  <div class="form-group">
    <label for="withdrawAmount">Amount (Rs.)</label>
    <input type="number" id="withdrawAmount" min="300" placeholder="Minimum 300" />
  </div>
  <div class="form-group">
    <label for="withdrawMethod">Payment Method</label>
    <select id="withdrawMethod">
      <option value="easypaisa">EasyPaisa</option>
      <option value="jazzcash">JazzCash</option>
      <option value="bank">Bank Transfer</option>
    </select>
  </div>
  <div class="form-group">
    <label for="accountNumber">Account Number</label>
    <input type="text" id="accountNumber" placeholder="Enter your account number" />
  </div>
  <div class="form-group">
    <label for="accountName">Account Name</label>
    <input type="text" id="accountName" placeholder="Enter account holder name" />
  </div>
  <button class="submit-btn" onclick="submitWithdraw()">Submit Withdrawal Request</button>

  <div class="transaction-history" id="withdrawHistory">
    <h3><i class="fas fa-history"></i> Withdrawal History</h3>
    <!-- Will be populated by JavaScript -->
  </div>
</div>

<!-- VIP Section -->
<div class="section" id="vipSection" style="display:none;">
  <h2><i class="fas fa-crown"></i> VIP Program</h2>
  <p style="color: var(--secondary);">Earn money by referring friends! When a user refers someone, the referral must make their first deposit. Only then will the referring user receive 5% of the referral's next withdrawal amount.</p>

  <div class="referral-stats">
    <div class="stat-box">
      <div class="stat-label">Total Referrals</div>
      <div class="stat-value" id="referralCount">0</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Your Earnings</div>
      <div class="stat-value" id="referralEarnings">Rs. 0</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">VIP Status</div>
      <div class="stat-value" id="vipStatus">Basic</div>
    </div>
  </div>

  <h3><i class="fas fa-user-plus"></i> Your Referral Code</h3>
  <div class="referral-code" id="userReferralCode">
    Login to see your code
    <i class="far fa-copy referral-code-copy" onclick="copyReferralCode()" title="Copy to clipboard" style="display:none;"></i>
  </div>

  <h3><i class="fas fa-info-circle"></i> How It Works</h3>
  <ol style="text-align: left; padding-left: 20px;">
    <li>Share your unique referral code with friends</li>
    <li>They sign up using your code and make their first deposit</li>
    <li>You earn <b>5% of their next withdrawal amount</b></li>
    <li>Withdraw your earnings anytime</li>
    <li>Reach higher VIP levels for more benefits</li>
  </ol>

  <button class="submit-btn" onclick="shareReferralCode()" style="margin-top: 20px;">
    <i class="fas fa-share-alt"></i> Share Your Referral Code
  </button>
</div>

<!-- More Section -->
<div class="section" id="moreSection" style="display:none;">
  <h2><i class="fas fa-ellipsis-h"></i> More</h2>

  <h3><i class="fas fa-clock"></i> Withdrawal Request Status</h3>
  <div class="transaction-history" id="withdrawStatus">
    <!-- Will be populated by JavaScript -->
  </div>

  <h3><i class="fas fa-exchange-alt"></i> Transaction History</h3>
  <div class="transaction-history" id="fullTransactionHistory">
    <!-- Will be populated by JavaScript -->
  </div>

  <button class="submit-btn" onclick="refreshAllData()" style="margin-top: 20px;">
    <i class="fas fa-sync-alt"></i> Refresh All Data
  </button>
</div>

<audio id="bgMusic" loop>
  <source src="https://cdn.pixabay.com/audio/2023/03/16/audio_98b541c254.mp3" type="audio/mp3">
</audio>
<audio id="flipSound">
  <source src="https://cdn.pixabay.com/download/audio/2022/10/03/audio_07d4930c1c.mp3" type="audio/mp3">
</audio>
<audio id="winSound">
  <source src="https://cdn.pixabay.com/download/audio/2022/03/21/audio_5a9f1d8e6b.mp3" type="audio/mp3">
</audio>
<audio id="loseSound">
  <source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0d8d2a5c8a.mp3" type="audio/mp3">
</audio>
<audio id="shotSound">
  <source src="https://cdn.pixabay.com/download/audio/2023/08/19/audio_5a9f1d8e6b.mp3" type="audio/mp3">
</audio>

<!-- Firebase SDK -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBM7DY6i11IPk8DAvVA6tsgmz7Epi5bJh0",
  authDomain: "pakcashplay.firebaseapp.com",
  projectId: "pakcashplay",
  storageBucket: "pakcashplay.appspot.com",
  messagingSenderId: "551195851632",
  appId: "1:551195851632:web:4dcf6a8fb36d82e6a6adb5"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Game variables
let balance = 0;
let selectedBet = null;
let gameStarted = false;
let currentUser = null;
let lastWithdrawRequestTime = 0;

// Initialize games when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  checkAuthState();
  setupGames();

  // Show welcome popup on first visit
  if (!localStorage.getItem('welcomeShown')) {
    document.getElementById('welcomePopup').style.display = 'flex';
    localStorage.setItem('welcomeShown', 'true');
  }
  
  // Try to play background music
  try {
    document.getElementById('bgMusic').volume = 0.3;
    document.getElementById('bgMusic').play();
  } catch (e) {
    console.log("Background music requires user interaction first");
  }
});

// Authentication functions
function checkAuthState() {
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById('authButtons').style.display = 'none';
      document.getElementById('logoutButton').style.display = 'block';
      document.getElementById('userDisplay').style.display = 'flex';
      loadUserData();
      
      // Check if user is admin
      db.collection('users').doc(user.uid).get().then(doc => {
        if (doc.exists) {
          const userData = doc.data();
          if (userData.email === 'cptanil1995@gmail.com' || userData.email === 'auk5562@gmail.com') {
            document.getElementById('adminButton').style.display = 'block';
          }
        }
      });
    } else {
      currentUser = null;
      document.getElementById('authButtons').style.display = 'flex';
      document.getElementById('logoutButton').style.display = 'none';
      document.getElementById('userDisplay').style.display = 'none';
      document.getElementById('adminButton').style.display = 'none';
      showSection('home');
      // Reset balance display when logged out
      document.getElementById('balanceAmount').textContent = '0';
    }
  });
}

function showAuthModal(tab) {
  document.getElementById('authModal').style.display = 'flex';
  switchAuthTab(tab);
}

function hideAuthModal() {
  document.getElementById('authModal').style.display = 'none';
}

function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

  if (tab === 'login') {
    document.querySelector('.auth-tab:nth-child(1)').classList.add('active');
    document.getElementById('loginForm').classList.add('active');
  } else if (tab === 'signup') {
    document.querySelector('.auth-tab:nth-child(2)').classList.add('active');
    document.getElementById('signupForm').classList.add('active');
  }
}

function showForgotPassword() {
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  document.getElementById('forgotPasswordForm').classList.add('active');
}

function backToLogin() {
  switchAuthTab('login');
}

function loginUser() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;

  if (!email || !password) {
    showToast('Please enter both email and password', 'error');
    return;
  }

  // Show loading state
  const loginBtn = document.querySelector('#loginForm button');
  loginBtn.disabled = true;
  loginBtn.textContent = 'Logging in...';

  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      hideAuthModal();
      showToast('Login successful! Welcome back.', 'success');

      // Update last login time
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).update({
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    })
    .catch(error => {
      let errorMessage = 'Login failed. ';
      switch(error.code) {
        case 'auth/user-not-found':
          errorMessage += 'No account found with this email.';
          break;
        case 'auth/wrong-password':
          errorMessage += 'Incorrect password.';
          break;
        case 'auth/invalid-email':
          errorMessage += 'The email address is invalid.';
          break;
        default:
          errorMessage += error.message;
      }
      showToast(errorMessage, 'error');
    })
    .finally(() => {
      // Reset button state
      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
    });
}

function signupUser() {
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const name = document.getElementById('signupName').value;
  const phone = document.getElementById('signupPhone').value;
  const referralCode = document.getElementById('referralCode').value;

  // Validate all required fields
  if (!email || !password || !name || !phone) {
    showToast('Please fill in all required fields', 'error');
    return;
  }

  // Validate email format
  if (!validateEmail(email)) {
    showToast('Please enter a valid email address', 'error');
    return;
  }

  // Validate password length
  if (password.length < 6) {
    showToast('Password should be at least 6 characters', 'error');
    return;
  }

  // Show loading state
  const signupBtn = document.querySelector('#signupForm button');
  signupBtn.disabled = true;
  signupBtn.textContent = 'Creating account...';

  // Create user with Firebase Auth
  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      // Create user document in Firestore
      return db.collection('users').doc(userCredential.user.uid).set({
        name: name,
        phone: phone,
        email: email,
        balance: 0, // No welcome bonus
        referralCode: generateReferralCode(),
        referredBy: referralCode || null,
        referralCount: 0,
        referralEarnings: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        depositCount: 0
      });
    })
    .then(() => {
      // If referral code was provided, update the referrer's stats
      if (referralCode) {
        return db.collection('users').where('referralCode', '==', referralCode).get()
          .then(querySnapshot => {
            if (!querySnapshot.empty) {
              const referrerId = querySnapshot.docs[0].id;
              return db.collection('users').doc(referrerId).update({
                referralCount: firebase.firestore.FieldValue.increment(1)
              });
            }
          });
      }
    })
    .then(() => {
      // Success - hide modal and show welcome message
      hideAuthModal();
      showToast('Signup successful! Welcome to USCash.', 'success');

      // Reset form
      document.getElementById('signupForm').reset();
    })
    .catch(error => {
      // Handle specific errors
      let errorMessage = 'Signup failed. ';
      switch(error.code) {
        case 'auth/email-already-in-use':
          errorMessage += 'This email is already registered.';
          break;
        case 'auth/invalid-email':
          errorMessage += 'The email address is invalid.';
          break;
        case 'auth/weak-password':
          errorMessage += 'The password is too weak.';
          break;
        default:
          errorMessage += error.message;
      }
      showToast(errorMessage, 'error');
    })
    .finally(() => {
      // Reset button state
      signupBtn.disabled = false;
      signupBtn.textContent = 'Sign Up';
    });
}

// Helper function to validate email
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function resetPassword() {
  const email = document.getElementById('forgotEmail').value;

  if (!email) {
    showToast('Please enter your email', 'error');
    return;
  }

  auth.sendPasswordResetEmail(email)
    .then(() => {
      showToast('Password reset email sent! Please check your inbox.', 'success');
      backToLogin();
    })
    .catch(error => {
      showToast('Error sending reset email: ' + error.message, 'error');
    });
}

function logoutUser() {
  auth.signOut().then(() => {
    showSection('home');
    showToast('Logged out successfully', 'success');
    // Reset balance to zero when logging out
    balance = 0;
    document.getElementById('balanceAmount').textContent = '0';
  });
}

function generateReferralCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

function copyReferralCode() {
  const referralCode = document.getElementById('userReferralCode').textContent;
  navigator.clipboard.writeText(referralCode)
    .then(() => {
      showToast('Referral code copied to clipboard!', 'success');
    })
    .catch(err => {
      console.error('Failed to copy: ', err);
    });
}

function shareReferralCode() {
  const referralCode = document.getElementById('userReferralCode').textContent;
  const shareText = `Join USCash and use my referral code: ${referralCode} to get bonus rewards!`;

  if (navigator.share) {
    navigator.share({
      title: 'USCash Referral',
      text: shareText,
      url: window.location.href
    })
    .catch(err => {
      console.error('Error sharing:', err);
      fallbackShare(referralCode, shareText);
    });
  } else {
    fallbackShare(referralCode, shareText);
  }
}

function fallbackShare(referralCode, shareText) {
  prompt('Copy your referral code to share:', shareText);
}

// Toast notification function
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast';
  
  if (type === 'success') {
    toast.style.borderColor = 'lime';
  } else if (type === 'error') {
    toast.style.borderColor = 'red';
  } else {
    toast.style.borderColor = 'var(--primary)';
  }
  
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// User data functions
function loadUserData() {
  if (!currentUser) return;

  db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
    if (doc.exists) {
      const userData = doc.data();
      balance = userData.balance || 0;
      updateBalanceDisplay();

      // Update user display
      document.getElementById('usernameDisplay').textContent = userData.name || userData.email || 'User';
      document.getElementById('phoneDisplay').textContent = userData.phone || '';

      // Check if user is verified (cptanil1995@gmail.com or auk5562@gmail.com)
      if (userData.email === 'cptanil1995@gmail.com' || userData.email === 'auk5562@gmail.com') {
        document.getElementById('verifiedBadge').style.display = 'inline-block';
      }

      // Update VIP section if visible
      if (document.getElementById('vipSection').style.display === 'block') {
        document.getElementById('userReferralCode').textContent = userData.referralCode || 'N/A';
        document.getElementById('referralCount').textContent = userData.referralCount || 0;
        document.getElementById('referralEarnings').textContent = 'Rs. ' + (userData.referralEarnings || 0);

        // Show copy button if referral code exists
        if (userData.referralCode) {
          document.querySelector('.referral-code-copy').style.display = 'block';
        }

        // Set VIP status
        const earnings = userData.referralEarnings || 0;
        let vipStatus = 'Basic';
        if (earnings >= 5000) vipStatus = 'Gold';
        else if (earnings >= 1000) vipStatus = 'Silver';
        document.getElementById('vipStatus').textContent = vipStatus;
      }
    }
  });

  // Load transaction history
  loadTransactionHistory();
}

function refreshBalance() {
  if (currentUser) {
    db.collection('users').doc(currentUser.uid).get()
      .then(doc => {
        if (doc.exists) {
          balance = doc.data().balance || 0;
          updateBalanceDisplay();
          showToast('Balance refreshed!', 'success');
        }
      });
  }
}

function refreshAllData() {
  refreshBalance();
  loadTransactionHistory();
  showToast('All data refreshed!', 'success');
}

function updateBalanceDisplay() {
  document.getElementById('balanceAmount').textContent = Math.floor(balance);
}

// Transaction functions
function submitDeposit() {
  if (!currentUser) {
    showToast('Please login to deposit', 'error');
    return;
  }

  const amount = parseFloat(document.getElementById('depositAmount').value);
  const method = document.getElementById('depositMethod').value;
  const transactionId = document.getElementById('transactionId').value;

  if (isNaN(amount) || amount < 150) {
    showToast('Minimum deposit amount is Rs. 150', 'error');
    return;
  }

  if (!transactionId) {
    showToast('Please enter transaction ID', 'error');
    return;
  }

  // Add deposit request
  db.collection('deposit_requests').add({
    userId: currentUser.uid,
    amount: amount,
    method: method,
    transactionId: transactionId,
    status: 'pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    // Update user balance
    return db.collection('users').doc(currentUser.uid).update({
      balance: firebase.firestore.FieldValue.increment(amount),
      depositCount: firebase.firestore.FieldValue.increment(1)
    });
  })
  .then(() => {
    // Check if user was referred by someone and update their earnings (5% of first 5 deposits)
    return db.collection('users').doc(currentUser.uid).get()
      .then(doc => {
        const userData = doc.data();
        if (userData.referredBy && userData.depositCount <= 5) {
          return db.collection('users').where('referralCode', '==', userData.referredBy).get()
            .then(querySnapshot => {
              if (!querySnapshot.empty) {
                const referrerId = querySnapshot.docs[0].id;
                const referralEarnings = amount * 0.05; // 5% of deposit
                return db.collection('users').doc(referrerId).update({
                  referralEarnings: firebase.firestore.FieldValue.increment(referralEarnings)
                });
              }
            });
        }
      });
  })
  .then(() => {
    showToast('Deposit request submitted successfully! Rs. ' + amount + ' added to your balance.', 'success');
    document.getElementById('depositAmount').value = '';
    document.getElementById('transactionId').value = '';
    loadTransactionHistory();
  })
  .catch(error => {
    showToast('Error submitting deposit: ' + error.message, 'error');
  });
}

function submitWithdraw() {
  if (!currentUser) {
    showToast('Please login to withdraw', 'error');
    return;
  }

  const amount = parseFloat(document.getElementById('withdrawAmount').value);
  const method = document.getElementById('withdrawMethod').value;
  const accountNumber = document.getElementById('accountNumber').value;
  const accountName = document.getElementById('accountName').value;

  if (isNaN(amount) || amount < 300) {
    showToast('Minimum withdrawal amount is Rs. 300', 'error');
    return;
  }

  if (amount > balance) {
    showToast('Insufficient balance', 'error');
    return;
  }

  if (!accountNumber || !accountName) {
    showToast('Please enter account details', 'error');
    return;
  }

  // Deduct amount from balance immediately
  db.collection('users').doc(currentUser.uid).update({
    balance: firebase.firestore.FieldValue.increment(-amount)
  })
  .then(() => {
    // Add withdrawal request
    return db.collection('withdraw_requests').add({
      userId: currentUser.uid,
      amount: amount,
      method: method,
      accountNumber: accountNumber,
      accountName: accountName,
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  })
  .then(() => {
    lastWithdrawRequestTime = Date.now();
    showToast('Withdrawal request submitted successfully! It will be processed within 24 hours.', 'success');
    document.getElementById('withdrawAmount').value = '';
    document.getElementById('accountNumber').value = '';
    document.getElementById('accountName').value = '';
    loadTransactionHistory();

    // Check if user was referred by someone and give 5% of withdrawal to referrer
    return db.collection('users').doc(currentUser.uid).get()
      .then(doc => {
        const userData = doc.data();
        if (userData.referredBy) {
          return db.collection('users').where('referralCode', '==', userData.referredBy).get()
            .then(querySnapshot => {
              if (!querySnapshot.empty) {
                const referrerId = querySnapshot.docs[0].id;
                const referralEarnings = amount * 0.05; // 5% of withdrawal
                return db.collection('users').doc(referrerId).update({
                  referralEarnings: firebase.firestore.FieldValue.increment(referralEarnings)
                });
              }
            });
        }
      });
  })
  .catch(error => {
    showToast('Error submitting withdrawal: ' + error.message, 'error');
  });
}

function loadTransactionHistory() {
  if (!currentUser) return;

  // Load deposit history
  db.collection('deposit_requests')
    .where('userId', '==', currentUser.uid)
    .orderBy('createdAt', 'desc')
    .limit(10)
    .get()
    .then(querySnapshot => {
      const depositHistory = document.getElementById('depositHistory');
      depositHistory.innerHTML = '<h3><i class="fas fa-history"></i> Deposit History</h3>';

      if (querySnapshot.empty) {
        depositHistory.innerHTML += '<p>No deposit history found</p>';
        return;
      }

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const item = document.createElement('div');
        item.className = 'transaction-item';

        let statusClass = 'transaction-pending';
        if (data.status === 'approved') statusClass = 'transaction-approved';
        if (data.status === 'rejected') statusClass = 'transaction-rejected';

        item.innerHTML = `
          <div>Amount: <span class="transaction-amount">Rs. ${data.amount}</span></div>
          <div>Method: ${data.method}</div>
          <div>Status: <span class="${statusClass}">${data.status}</span></div>
          <div>Date: ${data.createdAt?.toDate().toLocaleString() || 'N/A'}</div>
        `;

        depositHistory.appendChild(item);
      });
    });

  // Load withdrawal history
  db.collection('withdraw_requests')
    .where('userId', '==', currentUser.uid)
    .orderBy('createdAt', 'desc')
    .limit(10)
    .get()
    .then(querySnapshot => {
      const withdrawHistory = document.getElementById('withdrawHistory');
      withdrawHistory.innerHTML = '<h3><i class="fas fa-history"></i> Withdrawal History</h3>';

      if (querySnapshot.empty) {
        withdrawHistory.innerHTML += '<p>No withdrawal history found</p>';
        return;
      }

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const item = document.createElement('div');
        item.className = 'transaction-item';

        let statusClass = 'transaction-pending';
        if (data.status === 'approved') statusClass = 'transaction-approved';
        if (data.status === 'rejected') statusClass = 'transaction-rejected';

        item.innerHTML = `
          <div>Amount: <span class="transaction-amount">Rs. ${data.amount}</span></div>
          <div>Method: ${data.method}</div>
          <div>Status: <span class="${statusClass}">${data.status}</span></div>
          <div>Date: ${data.createdAt?.toDate().toLocaleString() || 'N/A'}</div>
        `;

        withdrawHistory.appendChild(item);
      });
    });

  // Load withdrawal status for "More" section
  db.collection('withdraw_requests')
    .where('userId', '==', currentUser.uid)
    .orderBy('createdAt', 'desc')
    .limit(5)
    .get()
    .then(querySnapshot => {
      const withdrawStatus = document.getElementById('withdrawStatus');
      withdrawStatus.innerHTML = '';

      if (querySnapshot.empty) {
        withdrawStatus.innerHTML = '<p>No withdrawal requests found</p>';
        return;
      }

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const item = document.createElement('div');
        item.className = 'transaction-item';

        let statusClass = 'transaction-pending';
        if (data.status === 'approved') statusClass = 'transaction-approved';
        if (data.status === 'rejected') statusClass = 'transaction-rejected';

        item.innerHTML = `
          <div>Amount: <span class="transaction-amount">Rs. ${data.amount}</span></div>
          <div>Status: <span class="${statusClass}">${data.status}</span></div>
          <div>Date: ${data.createdAt?.toDate().toLocaleString() || 'N/A'}</div>
        `;

        withdrawStatus.appendChild(item);
      });
    });

  // Load full transaction history
  const fullHistory = document.getElementById('fullTransactionHistory');
  fullHistory.innerHTML = '';

  // Combine deposits and withdrawals for full history
  Promise.all([
    db.collection('deposit_requests')
      .where('userId', '==', currentUser.uid)
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get(),
    db.collection('withdraw_requests')
      .where('userId', '==', currentUser.uid)
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get()
  ])
  .then(([deposits, withdrawals]) => {
    const allTransactions = [];

    deposits.forEach(doc => {
      const data = doc.data();
      allTransactions.push({
        type: 'deposit',
        amount: data.amount,
        status: data.status,
        date: data.createdAt,
        method: data.method
      });
    });

    withdrawals.forEach(doc => {
      const data = doc.data();
      allTransactions.push({
        type: 'withdrawal',
        amount: data.amount,
        status: data.status,
        date: data.createdAt,
        method: data.method
      });
    });

    // Sort by date
    allTransactions.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

    if (allTransactions.length === 0) {
      fullHistory.innerHTML = '<p>No transaction history found</p>';
      return;
    }

    allTransactions.forEach(trans => {
      const item = document.createElement('div');
      item.className = 'transaction-item';

      let statusClass = 'transaction-pending';
      if (trans.status === 'approved') statusClass = 'transaction-approved';
      if (trans.status === 'rejected') statusClass = 'transaction-rejected';

      item.innerHTML = `
        <div>Type: ${trans.type === 'deposit' ? 'Deposit' : 'Withdrawal'}</div>
        <div>Amount: <span class="transaction-amount">Rs. ${trans.amount}</span></div>
        <div>Method: ${trans.method}</div>
        <div>Status: <span class="${statusClass}">${trans.status}</span></div>
        <div>Date: ${trans.date?.toDate().toLocaleString() || 'N/A'}</div>
      `;

      fullHistory.appendChild(item);
    });
  });
}

// Navigation functions
function showSection(section) {
  document.querySelectorAll('.section').forEach(sec => {
    sec.style.display = 'none';
  });

  switch(section) {
    case 'home':
      document.getElementById('homeSection').style.display = 'block';
      break;
    case 'deposit':
      if (!currentUser) {
        showAuthModal('login');
        return;
      }
      document.getElementById('depositSection').style.display = 'block';
      break;
    case 'withdraw':
      if (!currentUser) {
        showAuthModal('login');
        return;
      }
      document.getElementById('withdrawSection').style.display = 'block';
      break;
    case 'vip':
      if (!currentUser) {
        showAuthModal('login');
        return;
      }
      document.getElementById('vipSection').style.display = 'block';
      // Load VIP data if not already loaded
      if (document.getElementById('userReferralCode').textContent === 'Login to see your code') {
        loadUserData();
      }
      break;
    case 'more':
      if (!currentUser) {
        showAuthModal('login');
        return;
      }
      document.getElementById('moreSection').style.display = 'block';
      loadTransactionHistory();
      break;
  }
}

// Game setup
function setupGames() {
  setupScratchGame();
  setupFruitGame();
  setupTicTacToeGame();
  setupFindAceGame();
  setupArcheryGame();
}

// Scratch Game
let icons = ['üêÑ', 'üêî', 'üê±', 'üê∂', 'üê≠'];
let cardData = [];
let flippedCards = [];
let scratchChances = 4;

function setupScratchGame() {
  icons = ['üêÑ', 'üêî', 'üê±', 'üê∂', 'üê≠'];
  cardData = [];
  flippedCards = [];
  scratchChances = 4;
}

function startCardGame() {
  document.getElementById('scratchGame').style.display = 'block';
  document.getElementById('fruitGame').style.display = 'none';
  document.getElementById('tictactoeGame').style.display = 'none';
  document.getElementById('findAceGame').style.display = 'none';
  document.getElementById('archeryGame').style.display = 'none';
  bgMusic.play().catch(() => {});
  setupCards();
}

function setupCards() {
  flippedCards = [];
  cardData = [];
  gameStarted = false;
  scratchChances = 4;
  const grid = document.getElementById('cardGrid');
  grid.classList.remove('shake', 'glow');
  grid.innerHTML = '';
  document.getElementById("particles-js").style.display = "none";
  document.getElementById("result").innerText = '';

  // 9 cards with 3 sets of identical icons
  let allIcons = [];
  for (let i = 0; i < 3; i++) {
    // Select 3 random icons
    const randomIcons = [...icons].sort(() => 0.5 - Math.random()).slice(0, 3);
    randomIcons.forEach(icon => allIcons.push(icon));
  }

  allIcons.forEach((icon) => {
    const card = document.createElement('div');
    card.classList.add('card');
    card.dataset.icon = icon;
    grid.appendChild(card);
    cardData.push({ element: card, icon: icon });
  });
}

function selectBet(amount) {
  if (gameStarted) return;
  
  if (balance < amount) {
    showToast('Insufficient balance! Please deposit more to play.', 'error');
    return;
  }
  
  selectedBet = amount;
  balance -= amount;
  updateUserBalance(balance);
  updateBalanceDisplay();
  
  document.querySelectorAll('#scratchGame .bet-amounts .gold-box').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  revealAndShuffleCards();
}

function revealAndShuffleCards() {
  const grid = document.getElementById('cardGrid');
  setupCards();

  cardData.forEach(data => {
    data.element.innerText = data.icon;
    data.element.classList.add('flipped');
  });

  setTimeout(() => {
    // Shuffle with animation
    shuffleCards(cardData.map(c => ({el: c.element})), grid).then(() => {
      cardData.forEach(data => {
        data.element.innerText = '';
        data.element.classList.remove('flipped');
        data.element.onclick = () => flipCard(data.element);
      });
    });
  }, 2000);
}

// Animate swap between two card elements
function animateSwap(c1, c2, duration) {
  return new Promise(res => {
    c1.el.style.transition = `left ${duration}ms ease, top ${duration}ms ease`;
    c2.el.style.transition = `left ${duration}ms ease, top ${duration}ms ease`;

    // store current positions
    const l1 = c1.el.style.left, t1 = c1.el.style.top;
    const l2 = c2.el.style.left, t2 = c2.el.style.top;

    // swap visually
    c1.el.style.left = l2; c1.el.style.top = t2;
    c2.el.style.left = l1; c2.el.style.top = t1;

    setTimeout(() => {
      c1.el.style.transition = "";
      c2.el.style.transition = "";
      res();
    }, duration + 10);
  });
}

// Shuffle cards with visible speed change (7x difference)
async function shuffleCards(cards, container) {
  let swaps = 15; // total swaps
  let first = 100; // fastest (ms)
  let last = 700; // slowest (ms) ‚âà7x slower

  // Set initial positions
  cards.forEach((card, i) => {
    const row = Math.floor(i / 3);
    const col = i % 3;
    card.el.style.position = 'absolute';
    card.el.style.left = `${col * (90 + 15)}px`;
    card.el.style.top = `${row * (110 + 15)}px`;
  });

  for (let i = 0; i < swaps; i++) {
    let t = i / (swaps - 1);
    let dur = first + (last - first) * t;

    let a = Math.floor(Math.random() * cards.length);
    let b = a;
    while (b === a) b = Math.floor(Math.random() * cards.length);

    await animateSwap(cards[a], cards[b], dur);
    [cards[a], cards[b]] = [cards[b], cards[a]];
  }

  // Reset positions after shuffling
  cards.forEach(card => {
    card.el.style.position = '';
    card.el.style.left = '';
    card.el.style.top = '';
  });
}

function flipCard(card) {
  if (!selectedBet) {
    showToast("Please select a bet amount before starting!", 'error');
    return;
  }
  if (flippedCards.includes(card) || scratchChances <= 0) return;
  if (!gameStarted) gameStarted = true;

  card.classList.add('flipped');
  card.innerText = card.dataset.icon;
  flipSound.currentTime = 0;
  flipSound.play().catch(() => {});
  flippedCards.push(card);
  scratchChances--;

  if (flippedCards.length >= 2) {
    checkWin();
  }
}

function checkWin() {
  const iconsPicked = flippedCards.map(c => c.dataset.icon);
  const counts = {};
  iconsPicked.forEach(icon => counts[icon] = (counts[icon] || 0) + 1);

  // Need at least 2 matching icons to win
  const won = Object.values(counts).some(count => count >= 2);
  const result = document.getElementById('result');
  const grid = document.getElementById('cardGrid');

  if (won) {
    const winAmount = selectedBet * 2;
    balance += winAmount;
    updateUserBalance(balance);
    result.innerText = `üéâ You won! Rs. ${winAmount} added.`;
    grid.classList.add('glow');
    document.getElementById("particles-js").style.display = "block";
    document.getElementById('winSound').play().catch(() => {});
    setTimeout(() => document.getElementById("particles-js").style.display = "none", 2500);
  } else if (scratchChances <= 0) {
    result.innerText = `‚ùå You lost! Rs. ${selectedBet} deducted.`;
    grid.classList.add('shake');
    document.getElementById('loseSound').play().catch(() => {});
  }

  updateBalanceDisplay();

  setTimeout(() => {
    if (won || scratchChances <= 0) {
      result.innerText = '';
      setupCards();
      selectedBet = null;
      document.querySelectorAll('#scratchGame .bet-amounts .gold-box').forEach(btn => {
        btn.classList.remove('active');
      });
    }
  }, 2500);
}

function updateUserBalance(newBalance) {
  if (!currentUser) return;

  db.collection('users').doc(currentUser.uid).update({
    balance: newBalance
  })
  .catch(error => {
    console.error('Error updating balance:', error);
  });
}

// Fruit Game
const colors = ["red", "green", "yellow", "blue", "purple"];
const fruits = {
  red: "üçé",
  green: "üçè",
  yellow: "üçã",
  blue: "üçá",
  purple: "üçÜ"
};
const durations = {
  20: 8000,
  50: 15000,
  100: 30000,
  150: 45000,
  200: 60000
};

let targetColor = "";
let fruitScore = 0;
let fruitGameInterval, fruitGameTimer, fruitCountdownInterval;
let fruitGameStarted = false;
let fruitSelectedBet = 0;

function setupFruitGame() {
  setNewFruitTarget();
}

function startFruitGame() {
  document.getElementById('scratchGame').style.display = 'none';
  document.getElementById('fruitGame').style.display = 'block';
  document.getElementById('tictactoeGame').style.display = 'none';
  document.getElementById('findAceGame').style.display = 'none';
  document.getElementById('archeryGame').style.display = 'none';
  setNewFruitTarget();
}

function setNewFruitTarget() {
  targetColor = colors[Math.floor(Math.random() * colors.length)];
  document.getElementById("fruitTargetDisplay").innerHTML = `Target: Shoot the <b style="color:${targetColor};">${targetColor.toUpperCase()}</b> Fruit ${fruits[targetColor]}`;
}

function spawnFruit() {
  const shootArea = document.getElementById("shootArea");
  if (shootArea.childElementCount >= 10) return;

  const fruit = document.createElement("div");
  fruit.classList.add("fruit");

  const isTarget = Math.random() < 0.40;
  const color = isTarget ? targetColor : colors[Math.floor(Math.random() * colors.length)];
  fruit.style.color = color;
  fruit.innerText = fruits[color];

  const size = Math.random() * 30 + 20;
  fruit.style.fontSize = `${size}px`;

  const x = Math.random() * (shootArea.clientWidth - 40);
  fruit.style.left = `${x}px`;
  fruit.style.top = "-30px";

  fruit.addEventListener("click", () => {
    if (!fruitGameStarted || fruit.clicked) return;
    fruit.clicked = true;

    if (color === targetColor) {
      fruitScore++;
    } else {
      fruitScore = Math.max(0, fruitScore - 2);
    }
    document.getElementById("fruitScoreDisplay").textContent = `Score: ${fruitScore}`;
    fruit.remove();
  });

  shootArea.appendChild(fruit);

  let top = -30;
  const fallSpeed = setInterval(() => {
    top += 15;
    fruit.style.top = `${top}px`;
    if (top > shootArea.clientHeight) {
      clearInterval(fallSpeed);
      fruit.remove();
    }
  }, 50);
}

function startFruitRound(amount) {
  if (fruitGameStarted || balance < amount) {
    if (balance < amount) {
      showToast("Insufficient balance! Please deposit more to play.", 'error');
    }
    return;
  }

  balance -= amount;
  updateUserBalance(balance);
  updateBalanceDisplay();

  document.getElementById("shootArea").innerHTML = "";
  clearInterval(fruitGameInterval);
  clearInterval(fruitCountdownInterval);
  clearTimeout(fruitGameTimer);
  fruitScore = 0;
  document.getElementById("fruitScoreDisplay").innerText = "Score: 0";
  setNewFruitTarget();

  fruitSelectedBet = amount;
  fruitGameStarted = true;

  document.querySelectorAll('#fruitGame .bet-amounts .gold-box').forEach(btn => {
    btn.style.pointerEvents = "none";
    btn.style.opacity = "0.4";
  });

  let timeLeft = durations[amount] / 1000;
  document.getElementById("fruitCountdown").innerText = `Time: ${timeLeft}s`;

  fruitCountdownInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("fruitCountdown").innerText = `Time: ${timeLeft}s`;
    if (timeLeft <= 0) clearInterval(fruitCountdownInterval);
  }, 1000);

  fruitGameInterval = setInterval(spawnFruit, 200);

  fruitGameTimer = setTimeout(() => {
    clearInterval(fruitGameInterval);
    clearInterval(fruitCountdownInterval);
    fruitGameStarted = false;

    let winAmount = 0;
    if (fruitScore >= Math.floor(fruitSelectedBet * 1.5)) {
      winAmount = fruitSelectedBet * 2;
      balance += winAmount;
      updateUserBalance(balance);
      showToast(`üéâ Congratulations! You scored ${fruitScore} points (Target: ${Math.floor(fruitSelectedBet * 1.5)}).\nYou won Rs. ${winAmount}!`, 'success');
      document.getElementById('winSound').play().catch(() => {});
    } else {
      showToast(`‚ùå Game Over! You scored ${fruitScore} points (Target: ${Math.floor(fruitSelectedBet * 1.5)}).\nYou lost your bet of Rs. ${fruitSelectedBet}.`, 'error');
      document.getElementById('loseSound').play().catch(() => {});
    }

    updateBalanceDisplay();

    document.querySelectorAll('#fruitGame .bet-amounts .gold-box').forEach(btn => {
      btn.style.pointerEvents = "auto";
      btn.style.opacity = "1";
    });

    document.getElementById("shootArea").innerHTML = "";
    document.getElementById("fruitScoreDisplay").innerText = "";
    document.getElementById("fruitCountdown").innerText = "Time: 0s";
    setNewFruitTarget();

  }, durations[amount]);
}

// Tic Tac Toe Game
let ticTacToeBoard = ['', '', '', '', '', '', '', '', ''];
let currentPlayer = 'X';
let ticTacToeGameActive = false;
let ticTacToeBetAmount = 0;
let ticTacToeCountdown = 30;
let ticTacToeTimer;

function setupTicTacToeGame() {
  ticTacToeBoard = ['', '', '', '', '', '', '', '', ''];
  currentPlayer = 'X';
}

function startTicTacToeGame() {
  document.getElementById('scratchGame').style.display = 'none';
  document.getElementById('fruitGame').style.display = 'none';
  document.getElementById('tictactoeGame').style.display = 'block';
  document.getElementById('findAceGame').style.display = 'none';
  document.getElementById('archeryGame').style.display = 'none';
  setupTicTacToeGame();
  renderTicTacToeBoard();
}

function selectTicTacToeBet(amount) {
  if (ticTacToeGameActive) return;

  if (balance < amount) {
    showToast("Insufficient balance! Please deposit more to play.", 'error');
    return;
  }

  ticTacToeBetAmount = amount;
  document.querySelectorAll('#tictactoeGame .bet-amounts .gold-box').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  startTicTacToeRound();
}

function startTicTacToeRound() {
  ticTacToeGameActive = true;
  currentPlayer = 'X';
  ticTacToeBoard = ['', '', '', '', '', '', '', '', ''];
  ticTacToeCountdown = 30;

  balance -= ticTacToeBetAmount;
  updateUserBalance(balance);
  updateBalanceDisplay();

  document.getElementById('tictactoeCountdown').textContent = `Time: ${ticTacToeCountdown}s`;
  ticTacToeTimer = setInterval(() => {
    ticTacToeCountdown--;
    document.getElementById('tictactoeCountdown').textContent = `Time: ${ticTacToeCountdown}s`;

    if (ticTacToeCountdown <= 0) {
      clearInterval(ticTacToeTimer);
      endTicTacToeGame(false, "Time's up! Game ended in a draw.");
    }
  }, 1000);

  renderTicTacToeBoard();
  document.getElementById('tictactoeResult').textContent = "Your turn (X)";
}

function renderTicTacToeBoard() {
  const boardElement = document.getElementById('ticTacToeBoard');
  boardElement.innerHTML = '';

  for (let i = 0; i < 9; i++) {
    const cell = document.createElement('div');
    cell.className = 'tic-tac-toe-cell';
    cell.textContent = ticTacToeBoard[i];
    cell.onclick = () => makeTicTacToeMove(i);
    boardElement.appendChild(cell);
  }
}

function makeTicTacToeMove(index) {
  if (!ticTacToeGameActive || ticTacToeBoard[index] !== '' || currentPlayer !== 'X') return;

  ticTacToeBoard[index] = 'X';
  renderTicTacToeBoard();

  if (checkTicTacToeWin('X')) {
    endTicTacToeGame(true, "You won! Rs. " + (ticTacToeBetAmount * 2) + " added to your balance.");
    return;
  }

  if (!ticTacToeBoard.includes('')) {
    endTicTacToeGame(false, "Game ended in a draw. You lost 25% of your bet.");
    return;
  }

  document.getElementById('tictactoeResult').textContent = "Computer thinking...";

  setTimeout(() => {
    let move = findWinningMove('O');
    if (move === -1) {
      move = findWinningMove('X');
      if (move === -1) {
        const emptyCells = [];
        for (let i = 0; i < 9; i++) {
          if (ticTacToeBoard[i] === '') emptyCells.push(i);
        }

        const smartMoves = [];
        const corners = [0, 2, 6, 8];
        for (const cell of emptyCells) {
          if (cell === 4) {
            move = cell;
            break;
          } else if (corners.includes(cell)) {
            smartMoves.push(cell);
          }
        }

        if (move === undefined && smartMoves.length > 0) {
            move = smartMoves[Math.floor(Math.random() * smartMoves.length)];
        } else if (move === undefined) {
            move = emptyCells[Math.floor(Math.random() * emptyCells.length)];
        }
      }
    }

    ticTacToeBoard[move] = 'O';
    renderTicTacToeBoard();

    if (checkTicTacToeWin('O')) {
      endTicTacToeGame(false, "Computer won! You lost your bet.");
      return;
    }

    if (!ticTacToeBoard.includes('')) {
      endTicTacToeGame(false, "Game ended in a draw. You lost 25% of your bet.");
      return;
    }

    document.getElementById('tictactoeResult').textContent = "Your turn (X)";
  }, 1000);
}

function findWinningMove(player) {
  const winPatterns = [
    [0, 1, 2], [3, 4, 5], [6, 7, 8],
    [0, 3, 6], [1, 4, 7], [2, 5, 8],
    [0, 4, 8], [2, 4, 6]
  ];

  for (const pattern of winPatterns) {
    const [a, b, c] = pattern;
    if (ticTacToeBoard[a] === player && ticTacToeBoard[b] === player && ticTacToeBoard[c] === '') return c;
    if (ticTacToeBoard[a] === player && ticTacToeBoard[c] === player && ticTacToeBoard[b] === '') return b;
    if (ticTacToeBoard[b] === player && ticTacToeBoard[c] === player && ticTacToeBoard[a] === '') return a;
  }

  return -1;
}

function checkTicTacToeWin(player) {
  const winPatterns = [
    [0, 1, 2], [3, 4, 5], [6, 7, 8],
    [0, 3, 6], [1, 4, 7], [2, 5, 8],
    [0, 4, 8], [2, 4, 6]
  ];

  return winPatterns.some(pattern => {
    return pattern.every(index => ticTacToeBoard[index] === player);
  });
}

function endTicTacToeGame(playerWon, message) {
  clearInterval(ticTacToeTimer);
  ticTacToeGameActive = false;

  if (playerWon) {
    const winAmount = ticTacToeBetAmount * 2;
    balance += winAmount;
    document.getElementById('winSound').play().catch(() => {});
  } else {
    const deduction = ticTacToeBetAmount * 0.25;
    balance -= deduction;
    document.getElementById('loseSound').play().catch(() => {});
  }

  updateUserBalance(balance);
  updateBalanceDisplay();

  document.getElementById('tictactoeResult').textContent = message;
  document.querySelectorAll('#tictactoeGame .bet-amounts .gold-box').forEach(btn => {
    btn.classList.remove('active');
  });

  if (playerWon) {
    document.getElementById("particles-js").style.display = "block";
    setTimeout(() => document.getElementById("particles-js").style.display = "none", 2500);
  }
}

// Find Ace Game
let findAceCards = ['K', 'Q', 'A']; // King, Queen, Ace
let findAceFlippedCards = [];
let findAceGameActive = false;
let findAceBetAmount = 0;
let findAceTimer;
let findAceCountdown = 15;

function setupFindAceGame() {
  findAceCards = ['K', 'Q', 'A'];
}

function startFindAceGame() {
  document.getElementById('scratchGame').style.display = 'none';
  document.getElementById('fruitGame').style.display = 'none';
  document.getElementById('tictactoeGame').style.display = 'none';
  document.getElementById('findAceGame').style.display = 'block';
  document.getElementById('archeryGame').style.display = 'none';
  setupFindAceGame();
}

function startFindAceRound(amount) {
  if (findAceGameActive || balance < amount) {
    if (balance < amount) {
      showToast("Insufficient balance! Please deposit more to play.", 'error');
    }
    return;
  }

  findAceBetAmount = amount;
  findAceGameActive = true;
  findAceFlippedCards = [];

  balance -= amount;
  updateUserBalance(balance);
  updateBalanceDisplay();

  document.getElementById('findAceResult').textContent = '';
  document.getElementById('findAceGrid').innerHTML = '';

  const grid = document.getElementById('findAceGrid');
  
  // Create 3 cards with white back
  findAceCards.forEach((card, index) => {
    const cardElement = document.createElement('div');
    cardElement.className = 'card';
    cardElement.style.background = 'white';
    cardElement.dataset.value = card;
    cardElement.dataset.index = index;
    grid.appendChild(cardElement);
  });

  findAceCountdown = 15;
  document.getElementById('findAceCountdown').textContent = `Time: ${findAceCountdown}s`;

  const countdownInterval = setInterval(() => {
    findAceCountdown--;
    document.getElementById('findAceCountdown').textContent = `Time: ${findAceCountdown}s`;

    if (findAceCountdown <= 0) {
      clearInterval(countdownInterval);
      endFindAceRound(false, "Time's up! You lost your bet.");
    }
  }, 1000);

  // Show cards briefly
  setTimeout(() => {
    document.querySelectorAll('#findAceGrid .card').forEach(card => {
      card.textContent = card.dataset.value;
    });
  }, 1000);

  // Hide cards and start shuffling
  setTimeout(() => {
    document.querySelectorAll('#findAceGrid .card').forEach(card => {
      card.textContent = '';
    });

    // Shuffle with animation
    const cards = Array.from(document.querySelectorAll('#findAceGrid .card'));
    shuffleCards(cards.map(c => ({el: c})), grid).then(() => {
      document.querySelectorAll('#findAceGrid .card').forEach(card => {
        card.onclick = () => flipFindAceCard(card);
      });
    });
  }, 3000);
}

function flipFindAceCard(card) {
  if (!findAceGameActive || card.classList.contains('flipped')) return;

  card.classList.add('flipped');
  card.textContent = card.dataset.value;
  flipSound.currentTime = 0;
  flipSound.play().catch(() => {});

  if (card.dataset.value === 'A') {
    endFindAceRound(true, "üéâ You found the Ace! You win double your bet.");
  } else {
    endFindAceRound(false, "‚ùå Wrong card! You lost your bet.");
  }
}

function endFindAceRound(won, message) {
  findAceGameActive = false;

  if (won) {
    const winAmount = findAceBetAmount * 2;
    balance += winAmount;
    document.getElementById('winSound').play().catch(() => {});
  } else {
    document.getElementById('loseSound').play().catch(() => {});
  }

  updateUserBalance(balance);
  updateBalanceDisplay();

  document.getElementById('findAceResult').textContent = message;

  if (won) {
    document.getElementById("particles-js").style.display = "block";
    setTimeout(() => document.getElementById("particles-js").style.display = "none", 2500);
  }
}

// Archery Game - Complete Implementation
let archeryBet = 0;
let archeryShots = [];
let archeryAutoMode = false;
let archeryGameActive = false;

function setupArcheryGame() {
  const canvas = document.getElementById('archeryCanvas');
  const ctx = canvas.getContext('2d');

  let DPR = window.devicePixelRatio || 1;
  function fixCanvas() {
    const cssW = canvas.clientWidth || canvas.width;
    const cssH = canvas.clientHeight || canvas.height;
    canvas.width = Math.round(cssW * DPR);
    canvas.height = Math.round(cssH * DPR);
    canvas.style.width = cssW + 'px';
    canvas.style.height = cssH + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  fixCanvas();
  window.addEventListener('resize', () => { fixCanvas(); drawArchery(); });

  const W = canvas.width / DPR;
  const H = canvas.height / DPR;
  const cx = W/2;
  const cy = H/2;

  let boardRadius = Math.min(W,H) * 0.35;

  const ringDefs = [
    {score:10, colorInner:'#ffdd66', colorOuter:'#ffcc00', radiusRatio:0.06},
    {score:8, colorInner:'#ffb76b', colorOuter:'#ff8f2e', radiusRatio:0.16},
    {score:7, colorInner:'#ff6b6b', colorOuter:'#d6453b', radiusRatio:0.28},
    {score:5, colorInner:'#3aa0ff', colorOuter:'#1475c7', radiusRatio:0.45},
    {score:2, colorInner:'#2e3136', colorOuter:'#0f1112', radiusRatio:0.70},
    {score:1, colorInner:'#f6f6f6', colorOuter:'#e9e9e9', radiusRatio:1.00}
  ];

  const ringRadii = ringDefs.map(r => boardRadius * r.radiusRatio);

  let sight = {
    x: W - 8,
    y: cy,
    radius: 14,
    movingLeft: true,
    speed: 6.0,
    active: false,
    auto: false,
    _lastCross: false
  };

  function drawBoard(){
    const woodR = boardRadius * 1.08;
    const g = ctx.createLinearGradient(cx, cy-woodR, cx, cy+woodR);
    g.addColorStop(0,'#7a5232'); g.addColorStop(0.5,'#a8764f'); g.addColorStop(1,'#5b391f');
    ctx.beginPath();
    ctx.arc(cx, cy, woodR, 0, Math.PI*2);
    ctx.fillStyle = g; ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, boardRadius + 6, 0, Math.PI*2);
    ctx.fillStyle = '#f8f5ee'; ctx.fill();

    for(let i = ringDefs.length-1; i >= 0; i--){
      const rd = ringRadii[i];
      const def = ringDefs[i];
      const grad = ctx.createRadialGradient(cx, cy, rd*0.1, cx, cy, rd);
      grad.addColorStop(0, def.colorInner);
      grad.addColorStop(1, def.colorOuter);
      ctx.beginPath();
      ctx.arc(cx, cy, rd, 0, Math.PI*2);
      ctx.fillStyle = grad;
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx, cy, rd, 0, Math.PI*2);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(0,0,0,0.18)';
      ctx.stroke();
    }
      ctx.beginPath();
      ctx.arc(cx, cy, rd, 0, Math.PI*2);
      ctx.fillStyle = grad;
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx, cy, rd, 0, Math.PI*2);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(0,0,0,0.18)';
      ctx.stroke();
    }

    ctx.beginPath();
    ctx.arc(cx, cy, 2.2, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.06)';
    ctx.fill();
  }

  function drawSight(){
    if(!sight.active) return;
    ctx.save();
    ctx.translate(sight.x, sight.y);
    ctx.beginPath();
    ctx.arc(0,0, sight.radius+6, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(30,220,120,0.04)';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(0,0, sight.radius, 0, Math.PI*2);
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(180,255,200,0.95)';
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(-14,0); ctx.lineTo(-6,0);
    ctx.moveTo(6,0); ctx.lineTo(14,0);
    ctx.moveTo(0,-14); ctx.lineTo(0,-6);
    ctx.moveTo(0,6); ctx.lineTo(0,14);
    ctx.strokeStyle = 'rgba(180,255,200,0.9)';
    ctx.lineWidth = 1.6;
    ctx.stroke();
    ctx.restore();
  }

  function updateSight(){
    if(!sight.active) return;
    if(sight.movingLeft){
      sight.x -= sight.speed;
      if(sight.x <= 8){
        sight.x = 8;
        sight.movingLeft = false;
      }
    } else {
      sight.x += sight.speed;
      if(sight.x >= W - 8){
        sight.x = W - 8;
        sight.movingLeft = true;
      }
    }

    if(sight.auto){
      const centerBand = 8;
      if(!sight._lastCross && Math.abs(sight.x - cx) <= centerBand){
        sight._lastCross = true;
        performShot();
      } else if(Math.abs(sight.x - cx) > centerBand){
        sight._lastCross = false;
      }
    }
  }

  function computeScore(px, py){
    const dx = px - cx;
    const dy = py - cy;
    const dist = Math.sqrt(dx*dx + dy*dy);
    for(let i=0;i<ringRadii.length;i++){
      if(dist <= ringRadii[i]) {
        return ringDefs[i].score;
      }
    }
    return 0;
  }

  function performShot(){
    if(!sight.active) return;
    if(archeryBet === 0){
      document.getElementById('archeryStatus').textContent = 'You must select a bet first.';
      return;
    }
    if(archeryShots.length >= 5) return;

    const score = computeScore(sight.x, sight.y);
    archeryShots.push(score);
    refreshScoreBoxes();

    document.getElementById('archeryStatus').textContent = `Shot ${archeryShots.length} ‚Üí ${score} points`;
    document.getElementById('shotSound').play().catch(() => {});

    if(archeryShots.length === 5){
      sight.active = false;
      let allTen = archeryShots.every(s=> s === 10);
      if(allTen){
        balance += archeryBet * 2;
        document.getElementById('archeryStatus').textContent = `üéâ PERFECT! All 5 are bullseyes. You doubled your bet to Rs.${archeryBet*2}`;
        document.getElementById('winSound').play().catch(() => {});
        document.getElementById("particles-js").style.display = "block";
        setTimeout(() => document.getElementById("particles-js").style.display = "none", 2500);
      } else {
        document.getElementById('archeryStatus').textContent = `‚úñ You lost the bet of Rs.${archeryBet}.`;
        document.getElementById('loseSound').play().catch(() => {});
      }
      updateUserBalance(balance);
      updateBalanceDisplay();
    }
  }

  function refreshScoreBoxes(){
    const scoreBoxes = document.querySelectorAll('#archeryScoreRow .archery-score-box');
    for(let i=0;i<5;i++){
      scoreBoxes[i].textContent = archeryShots[i] !== undefined ? archeryShots[i] : '';
    }
  }

  canvas.addEventListener('click', ()=> {
    performShot();
  });

  function drawArchery(){
    ctx.clearRect(0,0,W,H);
    drawBoard();
    drawSight();
  }

  function loop(){
    updateSight();
    drawArchery();
    requestAnimationFrame(loop);
  }
  loop();

  window.selectArcheryBet = function(amount){
    if (archeryGameActive) return;

    if (balance < amount) {
      showToast("Insufficient balance! Please deposit more to play.", 'error');
      return;
    }

    archeryBet = amount;
    archeryShots = [];
    const scoreBoxes = document.querySelectorAll('#archeryScoreRow .archery-score-box');
    for(let b of scoreBoxes) b.textContent = '';
    sight.x = W - 8;
    sight.y = cy;
    sight.movingLeft = true;
    sight.active = true;
    archeryGameActive = true;

    balance -= amount;
    updateUserBalance(balance);
    updateBalanceDisplay();

    document.getElementById('archeryStatus').textContent = `Bet Rs. ${archeryBet} placed ‚Äî 5 shots. Click canvas to shoot when sight passes.`;
  };

  window.resetArcheryGame = function(){
    archeryBet = 0;
    archeryShots = [];
    const scoreBoxes = document.querySelectorAll('#archeryScoreRow .archery-score-box');
    for(let b of scoreBoxes) b.textContent = '';
    sight.active = false;
    archeryGameActive = false;
    document.getElementById('archeryStatus').textContent = 'Pick a bet to start';
  };

  window.toggleArcheryAuto = function(){
    archeryAutoMode = !archeryAutoMode;
    document.getElementById('archeryAutoBtn').textContent = 'Auto: ' + (archeryAutoMode ? 'ON' : 'OFF');
    sight.auto = archeryAutoMode;
  };
}

function startArcheryGame() {
  document.getElementById('scratchGame').style.display = 'none';
  document.getElementById('fruitGame').style.display = 'none';
  document.getElementById('tictactoeGame').style.display = 'none';
  document.getElementById('findAceGame').style.display = 'none';
  document.getElementById('archeryGame').style.display = 'block';
}

// Helper function to shuffle array
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// Admin panel functions
function showAdminPanel() {
  if (!currentUser) return;
  
  // Check if user is admin
  db.collection('users').doc(currentUser.uid).get().then(doc => {
    if (doc.exists) {
      const userData = doc.data();
      if (userData.email === 'cptanil1995@gmail.com' || userData.email === 'auk5562@gmail.com') {
        document.getElementById('adminPanel').style.display = 'block';
        loadAdminData();
      } else {
        showToast('Access denied. Admin only.', 'error');
      }
    }
  });
}

function hideAdminPanel() {
  document.getElementById('adminPanel').style.display = 'none';
}

function loadAdminData() {
  // Load users
  db.collection('users').get().then(querySnapshot => {
    const usersList = document.getElementById('adminUsersList');
    usersList.innerHTML = '';
    
    querySnapshot.forEach(doc => {
      const userData = doc.data();
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${userData.name || 'N/A'}</td>
        <td>${userData.email || 'N/A'}</td>
        <td>Rs. ${userData.balance || 0}</td>
        <td>
          <button class="gold-box" onclick="editUserBalance('${doc.id}', ${userData.balance || 0})">Edit Balance</button>
        </td>
      `;
      usersList.appendChild(row);
  });
  });
  
  // Load deposit requests
  db.collection('deposit_requests').orderBy('createdAt', 'desc').get().then(querySnapshot => {
    const depositRequests = document.getElementById('adminDepositRequests');
    depositRequests.innerHTML = '';
    
    querySnapshot.forEach(doc => {
      const data = doc.data();
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${data.userId}</td>
        <td>Rs. ${data.amount}</td>
        <td>${data.status}</td>
        <td>${data.createdAt?.toDate().toLocaleString() || 'N/A'}</td>
        <td>
          <button class="gold-box" onclick="updateRequestStatus('deposit_requests', '${doc.id}', 'approved')">Approve</button>
          <button class="gold-box" onclick="updateRequestStatus('deposit_requests', '${doc.id}', 'rejected')">Reject</button>
        </td>
      `;
      depositRequests.appendChild(row);
    });
  });
  
  // Load withdrawal requests
  db.collection('withdraw_requests').orderBy('createdAt', 'desc').get().then(querySnapshot => {
    const withdrawalRequests = document.getElementById('adminWithdrawalRequests');
    withdrawalRequests.innerHTML = '';
    
    querySnapshot.forEach(doc => {
      const data = doc.data();
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${data.userId}</td>
        <td>Rs. ${data.amount}</td>
        <td>${data.status}</td>
        <td>${data.createdAt?.toDate().toLocaleString() || 'N/A'}</td>
        <td>
          <button class="gold-box" onclick="updateRequestStatus('withdraw_requests', '${doc.id}', 'approved')">Approve</button>
          <button class="gold-box" onclick="updateRequestStatus('withdraw_requests', '${doc.id}', 'rejected')">Reject</button>
        </td>
      `;
      withdrawalRequests.appendChild(row);
    });
  });
}

function searchUsers() {
  const searchTerm = document.getElementById('adminUserSearch').value.toLowerCase();
  const rows = document.getElementById('adminUsersList').getElementsByTagName('tr');
  
  for (let i = 0; i < rows.length; i++) {
    const name = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
    const email = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
    
    if (name.includes(searchTerm) || email.includes(searchTerm)) {
      rows[i].style.display = '';
    } else {
      rows[i].style.display = 'none';
    }
  }
}

function editUserBalance(userId, currentBalance) {
  const newBalance = prompt('Enter new balance:', currentBalance);
  if (newBalance !== null && !isNaN(newBalance)) {
    db.collection('users').doc(userId).update({
      balance: parseFloat(newBalance)
    }).then(() => {
      showToast('Balance updated successfully', 'success');
      loadAdminData();
    }).catch(error => {
      showToast('Error updating balance: ' + error.message, 'error');
    });
  }
}

function updateRequestStatus(collection, docId, status) {
  db.collection(collection).doc(docId).update({
    status: status
  }).then(() => {
    showToast('Request status updated', 'success');
    loadAdminData();
  }).catch(error => {
    showToast('Error updating request: ' + error.message, 'error');
  });
}

function sendAnnouncement() {
  const announcementText = document.getElementById('announcementText').value;
  if (!announcementText) {
    showToast('Please enter announcement text', 'error');
    return;
  }
  
  db.collection('announcements').add({
    text: announcementText,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdBy: currentUser.uid
  }).then(() => {
    showToast('Announcement sent successfully', 'success');
    document.getElementById('announcementText').value = '';
  }).catch(error => {
    showToast('Error sending announcement: ' + error.message, 'error');
  });
}

function showAnnouncements() {
  db.collection('announcements').orderBy('createdAt', 'desc').limit(5).get().then(querySnapshot => {
    let message = 'Latest Announcements:\n\n';
    if (querySnapshot.empty) {
      message += 'No announcements yet.';
    } else {
      querySnapshot.forEach(doc => {
        const data = doc.data();
        message += `${data.createdAt?.toDate().toLocaleString()}: ${data.text}\n\n`;
      });
    }
    alert(message);
  });
}

// Particles effect
particlesJS("particles-js", {
  "particles": {
    "number": { "value": 100 },
    "color": { "value": "#FFD700" },
    "shape": { "type": "star" },
    "opacity": { "value": 0.8 },
    "size": { "value": 5 },
    "move": { "enable": true, "speed": 8 }
  },
  "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": false } } },
  "retina_detect": true
});
</script>
</body>
</html>
